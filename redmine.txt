yum -y install openssl-devel readline-devel zlib-devel curl-devel libyaml-devel libffi-devel \
 && yum -y install sqlite sqlite-devel \
 && yum -y install httpd httpd-devel \
 && yum -y install ImageMagick ImageMagick-devel ipa-pgothic-fonts \
 && yum -y install subversion subversion-devel subversion-javahl git \
 && yum clean all

# install ruby
wget -O ruby-2.2.3.tar.gz https://cache.ruby-lang.org/pub/ruby/2.2/ruby-2.2.3.tar.gz
tar zxf ruby-2.2.3.tar.gz -C /usr/local/src/
cd /usr/local/src/ruby-2.2.3/ \
 && ./configure --disable-install-doc \
 && make && make install

#ruby -v

# install bundler
gem install bundler --no-rdoc --no-ri

# get redmine source
wget -O redmine-3.3.2.tar.gz http://www.redmine.org/releases/redmine-3.3.2.tar.gz
tar zxf redmine-3.3.2.tar.gz -C /var/lib/
ln -s /var/lib/redmine-3.3.2 /var/lib/redmine

# edit database.yml
vi /var/lib/redmine/config/database.yml

# edit configuration.yml
/bin/cp /var/lib/redmine/config/configuration.yml.example /var/lib/redmine/config/configuration.yml
sed -i -e "s/^  rmagick_font_path:$/  rmagick_font_path: \/usr\/share\/fonts\/ipa-pgothic\/ipagp.ttf/g" /var/lib/redmine/config/configuration.yml


cd /var/lib/redmine

# install gem package
bundle install --without development test --path vendor/bundle

# generate secret key
bundle exec rake generate_secret_token

# create db
RAILS_ENV=production bundle exec rake db:migrate

# register default data
RAILS_ENV=production REDMINE_LANG=ja bundle exec rake redmine:load_default_data

## setup Passenger
# install passenger
gem install passenger --no-rdoc --no-ri

# install apache module
passenger-install-apache2-module --auto
# passenger-install-apache2-module --snippet

#
vi /etc/httpd/conf.d/redmine.conf

# edit httpd.conf (ServerName)
sed -i -e "s/^\#ServerName www.example.com:80$/ServerName localhost/g" /etc/httpd/conf/httpd.conf

ln -s /var/lib/redmine/public /var/www/html/redmine

chown -R apache:apache /var/lib/redmine/

service httpd configtest
systemctl enable httpd
systemctl start httpd

◆既存の移行
○ホスト側
・バックアップデータの配置と解凍
 /mnt/share/public/redmine-3.3.0.20170106.tgz

・コンテナへコピー設定ファイルのコピー
 docker cp /mnt/share/public/redmine-3.3.0.20170106.tgz redmine3.3:/usr/tmp/


○コンテナ側
・コンテナへログイン
docker exec -it redmine3.3 /bin/bash

・ファイルコピーの確認と解凍
ll /usr/tmp/

tar zxf /usr/tmp/redmine-3.3.0.20170106.tgz -C /usr/tmp/
ll /usr/tmp/redmine-3.3.0

・サービスの定義とバックアップ
 systemctl stop httpd

cd /var/lib/
tar zcf redmine-3.3.2.tgz redmine-3.3.2

・DBのコピー
/bin/cp -f /usr/tmp/redmine-3.3.0/db/redmine.sqlite3 /var/lib/redmine/db/

・メールの設定は、別途行う
https://daichiahl.wordpress.com/2016/01/10/redmine%E3%81%ABgmail%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%83%A1%E3%83%BC%E3%83%AB%E9%80%81%E4%BF%A1%E3%81%95%E3%81%9B%E3%82%8B/

less /var/lib/redmine/config/configuration.yml
-------
default:
  email_delivery:
    delivery_method: :smtp
    smtp_settings:
      address: "smtp.gmail.com"
      port: 587
      domain: "mail.gmail.com"
      authentication: :plain
      user_name: "[hogehoge]@gmail.com"
      password: "[password]"
-----
※redmine からのアクセスとわかるよう、user_nameに「hogehoge+redmine@gmail.com」というようにする。


・プラグインのコピー
 /bin/cp -Rf /usr/tmp/redmine-3.3.0/plugins/* /var/lib/redmine/plugins/
 ll /var/lib/redmine/plugins/

・プラグインのアップデート
cd /var/lib/redmine/plugins/redmine_mylyn_connector/
git pull

cd /var/lib/redmine/plugins/redmine_github_hook/
git pull

・テーマのコピー

/bin/cp -Rf /usr/tmp/redmine-3.3.0/public/themes/farend_basic /var/lib/redmine/public/themes/
/bin/cp -Rf /usr/tmp/redmine-3.3.0/public/themes/farend_fancy /var/lib/redmine/public/themes/

ll /var/lib/redmine/public/themes/

・テーマのアップデート
cd /var/lib/redmine/public/themes/farend_basic
git pull

cd /var/lib/redmine/public/themes/farend_fancy
git pull

・gemパッケージのインストール
bundle install --without development test --path vendor/bundle

・セッション暗号化用鍵の生成
cd /var/lib/redmine/
bundle exec rake generate_secret_token

・DBの更新
RAILS_ENV=production bundle exec rake db:migrate

・プラグイン用のDBの更新 
RAILS_ENV=production bundle exec rake redmine:plugins:migrate

・クリーンナップ
bundle exec rake tmp:cache:clear
bundle exec rake tmp:sessions:clear

・権限の変更
chown -R apache:apache /var/lib/redmine

・サービスの起動
systemctl start httpd

・ホスト側
systemctl restart httpd

○メールの送信確認（gmail）
https://daichiahl.wordpress.com/2016/01/10/redmine%E3%81%ABgmail%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E3%83%A1%E3%83%BC%E3%83%AB%E9%80%81%E4%BF%A1%E3%81%95%E3%81%9B%E3%82%8B/

・「管理」ｰ「設定」ー「メール通知」の「テストメールを送信」をクリック
　→エラーがメッセージが出る。

・gmailに「ブロックされたログインについてご確認ください」メールが送信されるため、
　本文中のリンク「安全性の低いアプリへのアクセスを許可」をクリックして、
　「安全性の低いアプリ」画面にて、「オンにする」にチェックする。
　
・再度、「テストメールを送信」をクリックして、送信されることを確認する。

